Vagrant.configure("2") do |config|
 
config.vm.define "ansible-controller" do |controller|
    controller.vm.hostname = "ansible-controller"
    controller.vm.box = "generic/debian12"

    controller.vm.network "private_network", ip: "192.168.1.254", virtualbox__intnet: "vboxnet5" # interface SOC
    controller.vm.network "private_network", ip: "192.168.2.254", virtualbox__intnet: "vboxnet4" # Interface Red Team
    controller.vm.network "private_network", ip: "10.10.0.254", virtualbox__intnet: "vboxnet3"   # Interface Poste client
    controller.vm.network "private_network", ip: "10.10.1.254", virtualbox__intnet: "vboxnet1"   # Interface Domaine 1
    controller.vm.network "private_network", ip: "10.10.2.254", virtualbox__intnet: "vboxnet2"   # Interface Domaine 2
    
    controller.vm.provision "file", source: "ansible/", destination: "/tmp/"
    
    controller.vm.provider "virtualbox" do |vb|
      vb.name = "ansibleController"
      vb.memory = 1024 # 2 Go de RAM
      vb.cpus = 1 # 2 processeurs
    end
  
    controller.vm.provision "shell", name: "ansible package setup", inline: <<-SHELL
      UBUNTU_CODENAME=jammy
      wget -O- "https://keyserver.ubuntu.com/pks/lookup?fingerprint=on&op=get&search=0x6125E2A8C77F2818FB7BD15B93C4A3FD7BB9C367" | gpg --dearmour -o /usr/share/keyrings/ansible-archive-keyring.gpg
      echo "deb [signed-by=/usr/share/keyrings/ansible-archive-keyring.gpg] http://ppa.launchpad.net/ansible/ansible/ubuntu $UBUNTU_CODENAME main" | tee /etc/apt/sources.list.d/ansible.list 

      sudo apt upadte --fix-missing && sudo apt update && sudo apt upgrade -y && sudo apt install ansible
    SHELL

    # controller.vm.provision "shell", name: "ansible package setup", inline: <<-SHELL
    #   UBUNTU_CODENAME=jammy
    #   wget -O- "https://keyserver.ubuntu.com/pks/lookup?fingerprint=on&op=get&search=0x6125E2A8C77F2818FB7BD15B93C4A3FD7BB9C367" | gpg --dearmour -o /usr/share/keyrings/ansible-archive-keyring.gpg
    #   echo "deb [signed-by=/usr/share/keyrings/ansible-archive-keyring.gpg] http://ppa.launchpad.net/ansible/ansible/ubuntu $UBUNTU_CODENAME main" | tee /etc/apt/sources.list.d/ansible.list 
    # SHELL
  
  end
end









    # controller.vm.provision "shell", name: "testdeux", inline: <<-SHELL
    #   sudo apt-get install sshpass
    # SHELL

    # controller.vm.provision "shell", name: "testdeux", inline: <<-SHELL
    #   sudo mkdir ansible
    #   sudo mv /home/vagrant/ansible.cfg /home/vagrant/ansible/ansible.cfg
    #   sudo mv /home/vagrant/inventory.ini /home/vagrant/ansible/inventory.ini
    #   sudo mv /home/vagrant/desactivation_carte_reseaux.yml /home/vagrant/ansible/desactivation_carte_reseaux.yml
    #   cd ansible
    #   ansible-playbook -i inventory.ini desactivation_carte_reseaux.yml
    # SHELL

    # # Machine 2 : Debian Test
  #   controller.vm.provision "shell", name: "agentlinux", inline: <<-SHELL
  #     sudo wget https://packages.wazuh.com/4.x/apt/pool/main/w/wazuh-agent/wazuh-agent_4.11.0-1_amd64.deb && sudo WAZUH_MANAGER='192.168.1.2' WAZUH_AGENT_NAME='ansible-controller' dpkg -i ./wazuh-agent_4.11.0-1_amd64.deb
  #     sudo systemctl daemon-reload
  #     sudo systemctl enable wazuh-agent
  #     sudo systemctl start wazuh-agent
  #   SHELL
  # end


  # config.vm.define "debian-test" do |testvm|
  #   testvm.vm.hostname = "debian-test"
  #   testvm.vm.box = "generic/debian12"
  #   testvm.vm.network "private_network", ip: "192.168.1.4"

  #   testvm.vm.provision "shell", name: "install_ssh", inline: <<-SHELL
  #     sudo apt-get update
  #     sudo apt-get install -y openssh-server
  #     sudo systemctl enable ssh
  #     sudo systemctl start ssh
  #     sudo useradd -m -s /bin/bash ansible
  #     echo 'ansible:ansible' | sudo chpasswd
  #     sudo sed -i 's/^#\?PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
  #     sudo systemctl restart ssh
  #     sudo usermod -aG sudo ansible
  #   SHELL
  #end      

